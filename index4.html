<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>“AutoResult: A Smart Filtering System for Online Assessments”</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(90deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
            position: relative;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .logo i {
            font-size: 2.5rem;
            color: #4fc3f7;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .upload-section {
            padding: 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #eaeaea;
        }

        .upload-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border: 2px dashed #4fc3f7;
            transition: all 0.3s ease;
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }

        .upload-container:hover {
            border-color: #1a237e;
            transform: translateY(-5px);
        }

        .upload-icon {
            font-size: 4rem;
            color: #4fc3f7;
            margin-bottom: 20px;
        }

        .upload-text h2 {
            font-size: 1.8rem;
            color: #1a237e;
            margin-bottom: 10px;
        }

        .upload-text p {
            color: #666;
            margin-bottom: 25px;
            font-size: 1rem;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-label {
            display: inline-block;
            background: linear-gradient(90deg, #4fc3f7 0%, #29b6f6 100%);
            color: white;
            padding: 15px 35px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(79, 195, 247, 0.4);
        }

        .file-label:hover {
            background: linear-gradient(90deg, #29b6f6 0%, #0288d1 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(79, 195, 247, 0.6);
        }

        .file-name {
            margin-top: 15px;
            font-size: 0.95rem;
            color: #666;
        }

        .upload-btn {
            background: linear-gradient(90deg, #1a237e 0%, #283593 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(26, 35, 126, 0.4);
            margin-top: 10px;
        }

        .upload-btn:hover:not(:disabled) {
            background: linear-gradient(90deg, #283593 0%, #3949ab 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(26, 35, 126, 0.6);
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .controls-section {
            padding: 30px 40px;
            background: #f0f4f8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .filter-controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 12px 20px;
            border-radius: 10px;
            border: 2px solid #ddd;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            background: white;
            color: #333;
            min-width: 200px;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #4fc3f7;
            box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.2);
        }

        .export-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .export-btn {
            background: linear-gradient(90deg, #43a047 0%, #2e7d32 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(67, 160, 71, 0.4);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover:not(:disabled) {
            background: linear-gradient(90deg, #2e7d32 0%, #1b5e20 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(67, 160, 71, 0.6);
        }

        .export-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .export-btn.single {
            background: linear-gradient(90deg, #fb8c00 0%, #f57c00 100%);
            box-shadow: 0 5px 15px rgba(251, 140, 0, 0.4);
        }

        .export-btn.single:hover:not(:disabled) {
            background: linear-gradient(90deg, #f57c00 0%, #ef6c00 100%);
            box-shadow: 0 8px 20px rgba(251, 140, 0, 0.6);
        }

        .stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
            min-width: 150px;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #1a237e;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }

        .data-section {
            padding: 30px 40px;
        }

        .branch-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .branch-tab {
            padding: 10px 25px;
            background: #f0f4f8;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #555;
            border: 2px solid transparent;
        }

        .branch-tab:hover {
            background: #e3e9f0;
            color: #1a237e;
        }

        .branch-tab.active {
            background: linear-gradient(90deg, #4fc3f7 0%, #29b6f6 100%);
            color: white;
            border-color: #4fc3f7;
        }

        .year-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .year-btn {
            padding: 10px 20px;
            background: #f0f4f8;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #555;
            border: 2px solid transparent;
        }

        .year-btn:hover {
            background: #e3e9f0;
            color: #1a237e;
        }

        .year-btn.active {
            background: #1a237e;
            color: white;
            border-color: #1a237e;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            margin-bottom: 40px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        thead {
            background: linear-gradient(90deg, #1a237e 0%, #283593 100%);
            color: white;
        }

        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 1rem;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        th:last-child {
            border-right: none;
        }

        th i {
            margin-left: 8px;
            opacity: 0.8;
        }

        tbody tr {
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background-color: #f9fbfd;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        tbody tr.absent-row {
            background-color: #ffebee;
        }

        tbody tr.absent-row:hover {
            background-color: #ffcdd2;
        }

        td {
            padding: 16px 15px;
            color: #444;
        }

        td.absent-cell {
            color: #c62828;
            font-style: italic;
            font-weight: 600;
        }

        .score-cell {
            font-weight: 700;
            text-align: center;
            border-radius: 8px;
            padding: 8px 12px;
            display: inline-block;
            min-width: 40px;
        }

        .score-high {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .score-medium {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .score-low {
            background-color: #ffebee;
            color: #c62828;
        }

        .branch-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            min-width: 80px;
            text-align: center;
        }

        .branch-cs {
            background: linear-gradient(90deg, #2196f3 0%, #1976d2 100%);
        }

        .branch-it {
            background: linear-gradient(90deg, #4caf50 0%, #388e3c 100%);
        }

        .branch-aids {
            background: linear-gradient(90deg, #9c27b0 0%, #7b1fa2 100%);
        }

        .branch-etc {
            background: linear-gradient(90deg, #ff9800 0%, #f57c00 100%);
        }

        .branch-me {
            background: linear-gradient(90deg, #795548 0%, #5d4037 100%);
        }

        .branch-civil {
            background: linear-gradient(90deg, #607d8b 0%, #455a64 100%);
        }

        .branch-other {
            background: linear-gradient(90deg, #757575 0%, #616161 100%);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 5rem;
            color: #ddd;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: #777;
        }

        .empty-state p {
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto 30px;
            line-height: 1.6;
        }

        .export-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .export-modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            padding: 40px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .export-modal h3 {
            font-size: 1.8rem;
            color: #1a237e;
            margin-bottom: 20px;
            text-align: center;
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .export-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            border: 2px solid #eee;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .export-option:hover {
            border-color: #4fc3f7;
            background: #f9fbfd;
        }

        .export-option.selected {
            border-color: #4fc3f7;
            background: #f0f9ff;
        }

        .export-option-icon {
            font-size: 2rem;
            color: #4fc3f7;
        }

        .export-option-text h4 {
            font-size: 1.2rem;
            color: #1a237e;
            margin-bottom: 5px;
        }

        .export-option-text p {
            color: #666;
            font-size: 0.95rem;
        }

        .export-modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .modal-btn.primary {
            background: linear-gradient(90deg, #1a237e 0%, #283593 100%);
            color: white;
        }

        .modal-btn.secondary {
            background: #f0f4f8;
            color: #333;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .export-progress {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .export-progress i {
            font-size: 3rem;
            color: #4fc3f7;
            margin-bottom: 15px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .export-progress p {
            color: #666;
            font-size: 1.1rem;
        }

        footer {
            background: #1a237e;
            color: white;
            padding: 25px 40px;
            text-align: center;
            font-size: 0.9rem;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .footer-links {
            display: flex;
            gap: 25px;
        }

        .footer-links a {
            color: #bbdefb;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-links a:hover {
            color: white;
        }

        .theme-toggle-container {
            position: absolute;
            top: 30px;
            right: 40px;
        }

        .theme-toggle-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: white;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .theme-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .dashboard-link {
            position: absolute;
            top: 30px;
            right: 110px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .dashboard-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 1200px) {
            .container {
                border-radius: 15px;
            }

            .controls-section {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats {
                width: 100%;
                justify-content: space-between;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            header,
            .upload-section,
            .controls-section,
            .data-section,
            footer {
                padding: 25px 20px;
            }

            h1 {
                font-size: 2rem;
            }

            .upload-container {
                padding: 20px;
            }

            .filter-controls,
            .export-controls {
                flex-direction: column;
                width: 100%;
            }

            .filter-select,
            .export-btn {
                width: 100%;
            }

            .stat-card {
                flex: 1;
                min-width: 120px;
            }

            .footer-content {
                flex-direction: column;
                text-align: center;
            }

            .export-modal-content {
                padding: 25px 20px;
            }

            .theme-toggle-container {
                top: 15px;
                right: 20px;
            }

            .dashboard-link {
                top: 15px;
                right: 80px;
                font-size: 14px;
                padding: 8px 15px;
            }
        }
    </style>
</head>

<body>
    
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-cloud-upload-alt"></i>
                <div>
                    <h1 Fi>AutoEval – Smart Filtering System</h1>
                    <p class="subtitle">Upload your Online assessment's result excel files and export sorted data according to the branch and division wise.</p>
                </div>
            </div>

            <a href="loginpage.html" class="dashboard-link"> 
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>

            <div class="theme-toggle-container">
                <button id="themeToggle" class="theme-toggle-btn">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
            </div>
        </header>

        <section class="upload-section">
            <div class="upload-container">
                <div class="upload-icon">
                    <i class="fas fa-file-excel"></i>
                </div>
                <div class="upload-text">
                    <h2>Upload Excel File</h2>
                    <p>Upload an Excel file (.xlsx, .xls) containing student responses. Export branch-wise sorted data to separate Excel sheets.</p>

                    <div class="file-input-wrapper">
                        <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls">
                        <label for="excelFile" class="file-label">
                            <i class="fas fa-folder-open"></i> Choose Excel File
                        </label>
                    </div>

                    <div id="fileName" class="file-name">No file selected</div>

                    <button id="processBtn" class="upload-btn" disabled>
                        <i class="fas fa-cloud-upload-alt"></i> Process File
                    </button>
                </div>
            </div>
        </section>

        <section class="controls-section" style="display: none;" id="controlsSection">
            <div class="filter-controls">
                <select id="branchFilter" class="filter-select">
                    <option value="all">All Branches</option>
                </select>

                <select id="divisionFilter" class="filter-select">
                    <option value="all">All Divisions</option>
                </select>

                <select id="yearFilter" class="filter-select">
                    <option value="all">All Years</option>
                </select>

                <select id="sortFilter" class="filter-select">
                    <option value="roll_asc">Sort by Roll No (Ascending)</option>
                    <option value="roll_desc">Sort by Roll No (Descending)</option>
                    <option value="name_asc">Sort by Name (A-Z)</option>
                    <option value="score_desc">Sort by Score (High to Low)</option>
                </select>
            </div>

            <div class="export-controls">
                <button id="saveFilteredBtn" class="export-btn" style="background: linear-gradient(90deg, #9c27b0 0%, #7b1fa2 100%); box-shadow: 0 5px 15px rgba(156, 39, 176, 0.4);" disabled>
                    <i class="fas fa-save"></i> Save Filtered Data
                </button>
                <button id="exportSingleBtn" class="export-btn single" disabled>
                    <i class="fas fa-file-export"></i> Export Visible Data
                </button>
                <button id="exportMultiBtn" class="export-btn" disabled>
                    <i class="fas fa-layer-group"></i> Export Branch-wise
                </button>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalBranches">0</div>
                    <div class="stat-label">Branches</div>
                </div>
                <div class="stat-card"> 
                    <div class="stat-value" id="avgScore">0</div>
                    <div class="stat-label">Avg Score</div>
                </div>
            </div>
        </section>

        <section class="data-section" style="display: none;" id="dataSection">
            <div class="branch-tabs" id="branchTabs"></div>

            <div class="year-filter" id="yearFilterBtns"></div>

            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Roll No <i class="fas fa-sort-numeric-down"></i></th>
                            <th>Name <i class="fas fa-user"></i></th>
                            <th>Branch <i class="fas fa-code-branch"></i></th>
                            <th>Division</th>
                            <th>Year <i class="fas fa-calendar-alt"></i></th>
                            <th>Score <i class="fas fa-chart-line"></i></th>
                            <th>PRN <i class="fas fa-id-card"></i></th>
                            <th>Email <i class="fas fa-envelope"></i></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <div class="empty-state" id="emptyState">
                <div class="empty-icon">
                    <i class="fas fa-cloud"></i>
                </div>
                <h3>No Data Loaded Yet</h3>
                <p>Upload an Excel file using the upload section above to view student data sorted by branch and roll number.</p>
            </div>
        </section>

        <div class="export-modal" id="exportModal">
            <div class="export-modal-content">
                <h3>Export Options</h3>

                <div class="export-options">
                    <div class="export-option selected" id="optionMultiSheet">
                        <div class="export-option-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="export-option-text">
                            <h4>Multiple Sheets (Branch-wise)</h4>
                            <p>Create one Excel file with separate sheets for each branch. Students are sorted by roll number within each branch.</p>
                        </div>
                    </div>

                    <div class="export-option" id="optionSingleSheet">
                        <div class="export-option-icon">
                            <i class="fas fa-file-excel"></i>
                        </div>
                        <div class="export-option-text">
                            <h4>Single Sheet (Current View)</h4>
                            <p>Export the currently filtered and sorted data to a single Excel sheet.</p>
                        </div>
                    </div>
                </div>

                <div class="export-progress" id="exportProgress">
                    <i class="fas fa-spinner"></i>
                    <p>Preparing Excel file...</p>
                </div>

                <div class="export-modal-buttons" id="exportButtons">
                    <button class="modal-btn primary" id="confirmExport">
                        <i class="fas fa-file-download"></i> Export Now
                    </button>
                    <button class="modal-btn secondary" id="cancelExport">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <footer>
            <div class="footer-content">
                <div class="footer-text">
                    <p>Copyright &copy; 2026  All rights reserved </p>
                </div>
                <div class="footer-links">
                    <a href="#" id="helpLink"><i class="fas fa-question-circle"></i> Help</a>
                    <a href="#" id="aboutLink"><i class="fas fa-info-circle"></i> About</a>
                </div>
            </div>
            
        </footer>
    </div>
<h2 style="text-align:center">
  Made with ❤️ by 
  <a href="team.html" target="_blank" style="color: inherit; text-decoration: underline;">
    COD3 C4TLY5T
  </a>
</h2>

    <script>
      
const themeToggle = document.getElementById('themeToggle');
const themeIcon = document.getElementById('themeIcon');

function initTheme() {
    const savedTheme = localStorage.getItem('theme') ||
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');

    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        themeIcon.classList.remove('fa-moon');
        themeIcon.classList.add('fa-sun');
    }
}

themeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');

    if (document.body.classList.contains('dark-mode')) {
        localStorage.setItem('theme', 'dark');
        themeIcon.classList.remove('fa-moon');
        themeIcon.classList.add('fa-sun');
    } else {
        localStorage.setItem('theme', 'light');
        themeIcon.classList.remove('fa-sun');
        themeIcon.classList.add('fa-moon');
    }
});

const excelFileInput = document.getElementById('excelFile');
const fileNameDisplay = document.getElementById('fileName');
const processBtn = document.getElementById('processBtn');
const controlsSection = document.getElementById('controlsSection');
const dataSection = document.getElementById('dataSection');
const branchFilter = document.getElementById('branchFilter');
const divisionFilter = document.getElementById('divisionFilter');
const yearFilter = document.getElementById('yearFilter');
const sortFilter = document.getElementById('sortFilter');
const branchTabs = document.getElementById('branchTabs');
const yearFilterBtns = document.getElementById('yearFilterBtns');
const tableBody = document.getElementById('tableBody');
const emptyState = document.getElementById('emptyState');
const totalStudentsEl = document.getElementById('totalStudents');
const totalBranchesEl = document.getElementById('totalBranches');
const avgScoreEl = document.getElementById('avgScore');
const exportSingleBtn = document.getElementById('exportSingleBtn');
const exportMultiBtn = document.getElementById('exportMultiBtn');
const saveFilteredBtn = document.getElementById('saveFilteredBtn');
const exportModal = document.getElementById('exportModal');
const optionMultiSheet = document.getElementById('optionMultiSheet');
const optionSingleSheet = document.getElementById('optionSingleSheet');
const exportProgress = document.getElementById('exportProgress');
const exportButtons = document.getElementById('exportButtons');
const confirmExport = document.getElementById('confirmExport');
const cancelExport = document.getElementById('cancelExport');
const helpLink = document.getElementById('helpLink');
const aboutLink = document.getElementById('aboutLink');

let rawData = [];
let processedData = [];
let currentBranch = 'all';
let currentDivision = 'all';
let currentYear = 'all';
let currentSort = 'roll_asc';
let branches = new Set();
let divisions = new Set();
let years = new Set();
let exportType = 'multi';

excelFileInput.addEventListener('change', function (e) {
    if (e.target.files.length > 0) {
        const file = e.target.files[0];
        fileNameDisplay.textContent = `Selected: ${file.name}`;
        fileNameDisplay.style.color = '#1a237e';
        fileNameDisplay.style.fontWeight = '600';
        processBtn.disabled = false;
    } else {
        fileNameDisplay.textContent = 'No file selected';
        fileNameDisplay.style.color = '#666';
        fileNameDisplay.style.fontWeight = 'normal';
        processBtn.disabled = true;
    }
});

processBtn.addEventListener('click', processExcelFile);

branchFilter.addEventListener('change', function () {
    currentBranch = this.value;
    updateBranchTabs();
    filterAndDisplayData();
});

divisionFilter.addEventListener('change', function () {
    currentDivision = this.value;
    filterAndDisplayData();
});

yearFilter.addEventListener('change', function () {
    currentYear = this.value;
    updateYearFilterButtons();
    filterAndDisplayData();
});

sortFilter.addEventListener('change', function () {
    currentSort = this.value;
    filterAndDisplayData();
});

saveFilteredBtn.addEventListener('click', saveFilteredDataToDashboard);

exportSingleBtn.addEventListener('click', function () {
    exportType = 'single';
    showExportModal();
});

exportMultiBtn.addEventListener('click', function () {
    exportType = 'multi';
    showExportModal();
});

optionMultiSheet.addEventListener('click', function () {
    exportType = 'multi';
    optionMultiSheet.classList.add('selected');
    optionSingleSheet.classList.remove('selected');
});

optionSingleSheet.addEventListener('click', function () {
    exportType = 'single';
    optionSingleSheet.classList.add('selected');
    optionMultiSheet.classList.remove('selected');
});

confirmExport.addEventListener('click', performExport);
cancelExport.addEventListener('click', hideExportModal);


helpLink.addEventListener('click', function (e) {
    e.preventDefault();
    alert("Export Help:\n\n1. 'Export Visible Data': Exports the currently filtered data to a single Excel sheet.\n\n2. 'Export Branch-wise': Creates an Excel file with separate sheets for each branch, with students sorted by roll number within each branch.\n\n3. 'Save Filtered Data': Saves only the filtered and sorted data to dashboard.\n\n4. Use the filters to select specific branches or years before exporting.\n\n5. Missing roll numbers are automatically detected and marked as 'Absent' in red.");
});

aboutLink.addEventListener('click', function (e) {
    e.preventDefault();
    alert("VIT Cloud Computing Data Analyzer\n\nThis tool helps teachers process student submission data from Excel files. It automatically sorts students by branch and roll number, and allows exporting branch-wise data to separate Excel sheets.\n\nFeatures:\n- Upload Excel files with student data\n- Filter by branch and year\n- Sort by various criteria\n- Save filtered data to dashboard\n- Automatic detection of missing roll numbers (Absent)\n- Export to Excel with branch-wise division\n- Visual statistics and reporting");
})
function showExportModal() {
    exportModal.style.display = 'flex';
    exportProgress.style.display = 'none';
    exportButtons.style.display = 'flex';

    if (exportType === 'multi') {
        optionMultiSheet.classList.add('selected');
        optionSingleSheet.classList.remove('selected');
    } else {
        optionSingleSheet.classList.add('selected');
        optionMultiSheet.classList.remove('selected');
    }
}

function hideExportModal() {
    exportModal.style.display = 'none';
}

function processExcelFile() {
    const file = excelFileInput.files[0];
    if (!file) return;

    processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    processBtn.disabled = true;

    const reader = new FileReader();

    reader.onload = function (e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });

            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];

            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            processData(jsonData);

            controlsSection.style.display = 'block';
            dataSection.style.display = 'block';
            emptyState.style.display = 'none';

            exportSingleBtn.disabled = false;
            exportMultiBtn.disabled = false;
            saveFilteredBtn.disabled = false;

            processBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Process File';
            processBtn.disabled = false;


            setTimeout(saveToTeacherDashboard, 500);

        } catch (error) {
            console.error('Error processing file:', error);
            alert('Error processing the Excel file. Please make sure it is in the correct format.');
            processBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Process File';
            processBtn.disabled = false;
        }
    };

    reader.readAsArrayBuffer(file);
}

function processData(jsonData) {
    rawData = [];
    processedData = [];
    branches.clear();
    divisions.clear();
    years.clear();

    for (let i = 1; i < jsonData.length; i++) {
        const row = jsonData[i];

        if (row.length >= 8) {
            const branchInfo = extractBranchAndDivision(row[6]);

            const student = {
                timestamp: row[0] || '',
                email: row[1] || '',
                score: parseInt(row[2]) || 0,
                name: row[3] || '',
                rollNo: row[4] || '',
                prn: row[5] || '',
                branch: branchInfo.branch,
                division: branchInfo.division,
                year: row[7] || '',
                isAbsent: false
            };

            if (student.branch) branches.add(student.branch);
            if (student.division) divisions.add(student.division);
            if (student.year) years.add(student.year);

            rawData.push(student);
        }
    }

    processedData = [...rawData].sort((a, b) => {
        if (a.branch < b.branch) return -1;
        if (a.branch > b.branch) return 1;

        const rollA = parseInt(a.rollNo) || a.rollNo;
        const rollB = parseInt(b.rollNo) || b.rollNo;

        if (rollA < rollB) return -1;
        if (rollA > rollB) return 1;
        return 0;
    });

    updateFilters();
    filterAndDisplayData();
}

function extractBranchAndDivision(branchRaw) {
    if (!branchRaw) {
        return { branch: 'UNKNOWN', division: '-' };
    }

    const str = branchRaw.toString().toUpperCase().replace(/\s+/g, '');

    let branch = 'OTHER';
    let division = '-';

    if (str.startsWith('CS')) branch = 'CS';
    else if (str.startsWith('IT')) branch = 'IT';
    else if (str.includes('ETC') || str.includes('ENTC')) branch = 'ETC';
    else if (str.includes('ME')) branch = 'ME';
    else if (str.includes('CIVIL')) branch = 'CIVIL';

    const match = str.match(/[-]?([A-Z])$/);
    if (match) division = match[1];

    return { branch, division };
}

function fillAbsentRollNumbers(students) {
    if (students.length === 0) return [];

    const rollNumbers = students
        .map(s => parseInt(s.rollNo.toString().replace(/\D/g, '')) || 0)
        .filter(n => n > 0)
        .sort((a, b) => a - b);

    if (rollNumbers.length === 0) return students;

    const minRoll = rollNumbers[0];
    const maxRoll = rollNumbers[rollNumbers.length - 1];
    const presentRolls = new Set(rollNumbers);

    const rangeSize = maxRoll - minRoll + 1;
    if (rangeSize > 200) {
        return students;
    }

    const result = [];

    for (let i = minRoll; i <= maxRoll; i++) {
        if (presentRolls.has(i)) {
            const student = students.find(s => {
                const rollNum = parseInt(s.rollNo.toString().replace(/\D/g, '')) || 0;
                return rollNum === i;
            });
            if (student) {
                result.push(student);
            }
        } else {
            result.push({
                timestamp: '',
                email: '',
                score: 0,
                name: 'Absent',
                rollNo: i.toString().padStart(2, '0'),
                prn: '',
                branch: students[0].branch,
                division: students[0].division,
                year: students[0].year,
                isAbsent: true
            });
        }
    }

    return result;
}

function updateFilters() {
    while (branchFilter.options.length > 1) {
        branchFilter.remove(1);
    }

    while (divisionFilter.options.length > 1) {
        divisionFilter.remove(1);
    }

    while (yearFilter.options.length > 1) {
        yearFilter.remove(1);
    }

    const sortedBranches = Array.from(branches).sort();
    sortedBranches.forEach(branch => {
        const option = document.createElement('option');
        option.value = branch;
        option.textContent = branch;
        branchFilter.appendChild(option);
    });

    const sortedDivisions = Array.from(divisions).sort();
    sortedDivisions.forEach(div => {
        const option = document.createElement('option');
        option.value = div;
        option.textContent = div;
        divisionFilter.appendChild(option);
    });

    const sortedYears = Array.from(years).sort();
    sortedYears.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearFilter.appendChild(option);
    });

    updateBranchTabs();
    updateYearFilterButtons();
    updateStatistics();
}

function updateBranchTabs() {
    branchTabs.innerHTML = '';

    const allTab = document.createElement('div');
    allTab.className = `branch-tab ${currentBranch === 'all' ? 'active' : ''}`;
    allTab.textContent = 'All Branches';
    allTab.dataset.branch = 'all';
    allTab.addEventListener('click', function () {
        currentBranch = this.dataset.branch;
        branchFilter.value = currentBranch;
        updateBranchTabs();
        filterAndDisplayData();
    });

    branchTabs.appendChild(allTab);

    const sortedBranches = Array.from(branches).sort();
    sortedBranches.forEach(branch => {
        const tab = document.createElement('div');
        tab.className = `branch-tab ${currentBranch === branch ? 'active' : ''}`;
        tab.textContent = branch;
        tab.dataset.branch = branch;
        tab.addEventListener('click', function () {
            currentBranch = this.dataset.branch;
            branchFilter.value = currentBranch;
            updateBranchTabs();
            filterAndDisplayData();
        });
        branchTabs.appendChild(tab);
    });
}

function updateYearFilterButtons() {
    yearFilterBtns.innerHTML = '';

    const allBtn = document.createElement('div');
    allBtn.className = `year-btn ${currentYear === 'all' ? 'active' : ''}`;
    allBtn.textContent = 'All Years';
    allBtn.dataset.year = 'all';
    allBtn.addEventListener('click', function () {
        currentYear = this.dataset.year;
        yearFilter.value = currentYear;
        updateYearFilterButtons();
        filterAndDisplayData();
    });
    yearFilterBtns.appendChild(allBtn);

    const sortedYears = Array.from(years).sort();
    sortedYears.forEach(year => {
        const btn = document.createElement('div');
        btn.className = `year-btn ${currentYear === year ? 'active' : ''}`;
        btn.textContent = year;
        btn.dataset.year = year;
        btn.addEventListener('click', function () {
            currentYear = this.dataset.year;
            yearFilter.value = currentYear;
            updateYearFilterButtons();
            filterAndDisplayData();
        });
        yearFilterBtns.appendChild(btn);
    });
}

function updateStatistics() {
    const totalStudents = rawData.length;
    const totalBranches = branches.size;

    let totalScore = 0;
    rawData.forEach(student => {
        totalScore += student.score;
    });
    const avgScore = totalStudents > 0 ? (totalScore / totalStudents).toFixed(1) : 0;

    totalStudentsEl.textContent = totalStudents;
    totalBranchesEl.textContent = totalBranches;
    avgScoreEl.textContent = avgScore;
}

function filterAndDisplayData() {
    let filteredData = processedData.filter(student => {
        const branchMatch = currentBranch === 'all' || student.branch === currentBranch;
        const yearMatch = currentYear === 'all' || student.year === currentYear;
        const divisionMatch = currentDivision === 'all' || student.division === currentDivision;
        return branchMatch && yearMatch && divisionMatch;
    });

    filteredData = sortData(filteredData, currentSort);

    const grouped = {};
    filteredData.forEach(student => {
        const key = `${student.branch}-${student.division}|${student.year}`;
        if (!grouped[key]) {
            grouped[key] = [];
        }
        grouped[key].push(student);
    });

    let dataWithAbsent = [];
    Object.values(grouped).forEach(group => {
        const groupWithAbsent = fillAbsentRollNumbers(group);
        dataWithAbsent = dataWithAbsent.concat(groupWithAbsent);
    });

    dataWithAbsent = sortData(dataWithAbsent, currentSort);

    displayData(dataWithAbsent);
    updateFilteredStatistics(dataWithAbsent);
}

function sortData(data, sortOption) {
    const sortedData = [...data];

    switch (sortOption) {
        case 'roll_asc':
            return sortedData.sort((a, b) => {
                const rollA = parseInt(a.rollNo) || a.rollNo;
                const rollB = parseInt(b.rollNo) || b.rollNo;
                if (rollA < rollB) return -1;
                if (rollA > rollB) return 1;
                return 0;
            });

        case 'roll_desc':
            return sortedData.sort((a, b) => {
                const rollA = parseInt(a.rollNo) || a.rollNo;
                const rollB = parseInt(b.rollNo) || b.rollNo;
                if (rollA > rollB) return -1;
                if (rollA < rollB) return 1;
                return 0;
            });

        case 'name_asc':
            return sortedData.sort((a, b) => {
                if (a.name < b.name) return -1;
                if (a.name > b.name) return 1;
                return 0;
            });

        case 'score_desc':
            return sortedData.sort((a, b) => b.score - a.score);

        default:
            return sortedData;
    }
}

function displayData(data) {
    tableBody.innerHTML = '';

    if (data.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 8;
        cell.style.textAlign = 'center';
        cell.style.padding = '50px';
        cell.style.color = '#666';
        cell.innerHTML = `
            <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px; display: block; color: #ccc;"></i>
            <h3 style="margin-bottom: 10px;">No matching students found</h3>
            <p>Try changing your filter criteria</p>
        `;
        row.appendChild(cell);
        tableBody.appendChild(row);
        return;
    }

    data.forEach(student => {
        const row = document.createElement('tr');

        if (student.isAbsent) {
            row.classList.add('absent-row');
        }

        let scoreClass = 'score-medium';
        if (student.score >= 25) scoreClass = 'score-high';
        else if (student.score < 15) scoreClass = 'score-low';

        let branchClass = 'branch-other';
        if (student.branch === 'CS') branchClass = 'branch-cs';
        else if (student.branch === 'IT') branchClass = 'branch-it';
        else if (student.branch === 'AIDS') branchClass = 'branch-aids';
        else if (student.branch === 'ETC') branchClass = 'branch-etc';
        else if (student.branch === 'ME') branchClass = 'branch-me';
        else if (student.branch === 'CIVIL') branchClass = 'branch-civil';

        if (student.isAbsent) {
            row.innerHTML = `
                <td class="absent-cell">${student.rollNo}</td>
                <td class="absent-cell">Absent</td>
                <td><span class="branch-badge ${branchClass}">${student.branch}</span></td>
                <td class="absent-cell">${student.division}</td>
                <td>${student.year}</td>
                <td class="absent-cell">-</td>
                <td class="absent-cell">-</td>
                <td class="absent-cell">-</td>
            `;
        } else {
            row.innerHTML = `
                <td>${student.rollNo}</td>
                <td><strong>${student.name}</strong></td>
                <td><span class="branch-badge ${branchClass}">${student.branch}</span></td>
                <td>${student.division}</td>
                <td>${student.year}</td>
                <td><span class="score-cell ${scoreClass}">${student.score}</span></td>
                <td>${student.prn}</td>
                <td><a href="mailto:${student.email}" style="color: #1a237e; text-decoration: none;">${student.email}</a></td>
            `;
        }

        tableBody.appendChild(row);
    });
}

function updateFilteredStatistics(filteredData) {
    const presentStudents = filteredData.filter(s => !s.isAbsent);
    const filteredCount = presentStudents.length;

    const totalStudentsElement = document.querySelector('.stat-card:nth-child(1) .stat-value');
    if (totalStudentsElement) {
        totalStudentsElement.textContent = filteredCount;

        if (filteredCount < rawData.length) {
            totalStudentsElement.style.color = '#f57c00';
            totalStudentsElement.title = `Filtered from ${rawData.length} total students`;
        } else {
            totalStudentsElement.style.color = '#1a237e';
            totalStudentsElement.title = '';
        }
    }
}
function performExport() {
    exportProgress.style.display = 'block';
    exportButtons.style.display = 'none';

    setTimeout(() => {
        try {
            if (exportType === 'multi') {
                exportBranchWiseExcel();
            } else {
                exportCurrentViewExcel();
            }

            hideExportModal();
            setTimeout(() => {
                alert(`Excel file exported successfully! ${exportType === 'multi' ? 'Check your downloads for the multi-sheet file.' : 'Check your downloads for the Excel file.'}`);
            }, 300);

        } catch (error) {
            console.error('Export error:', error);
            alert('Error exporting Excel file. Please try again.');
            hideExportModal();
        }
    }, 1000);
}

function exportCurrentViewExcel() {
    let filteredData = processedData.filter(student => {
        const branchMatch = currentBranch === 'all' || student.branch === currentBranch;
        const yearMatch = currentYear === 'all' || student.year === currentYear;
        const divisionMatch = currentDivision === 'all' || student.division === currentDivision;
        return branchMatch && yearMatch && divisionMatch;
    });

    filteredData = sortData(filteredData, currentSort);

    const grouped = {};
    filteredData.forEach(student => {
        const key = `${student.branch}-${student.division}|${student.year}`;
        if (!grouped[key]) {
            grouped[key] = [];
        }
        grouped[key].push(student);
    });

    let dataWithAbsent = [];
    Object.values(grouped).forEach(group => {
        const groupWithAbsent = fillAbsentRollNumbers(group);
        dataWithAbsent = dataWithAbsent.concat(groupWithAbsent);
    });

    dataWithAbsent = sortData(dataWithAbsent, currentSort);

    const exportData = dataWithAbsent.map(student => ({
        'Roll No': student.rollNo,
        'Name': student.name,
        'Branch': student.branch,
        'Division': student.division,
        'Year': student.year,
        'Score': student.isAbsent ? 'Absent' : student.score,
        'PRN': student.prn,
        'Email': student.email,
        'Timestamp': student.timestamp,
        'Status': student.isAbsent ? 'ABSENT' : 'Present'
    }));

    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Students');

    let fileName = 'student_data';
    if (currentBranch !== 'all') fileName += `_${currentBranch}`;
    if (currentDivision !== 'all') fileName += `_${currentDivision}`;
    if (currentYear !== 'all') fileName += `_${currentYear}`;
    fileName += `_${getCurrentTimestamp()}.xlsx`;

    XLSX.writeFile(wb, fileName);
}

function exportBranchWiseExcel() {
    const wb = XLSX.utils.book_new();
    const uniqueDivisions = [
        ...new Set(processedData.map(s => `${s.branch}-${s.division}`))
    ].sort();

    uniqueDivisions.forEach(div => {
        const [branch, division] = div.split('-');

        let branchStudents = processedData.filter(
            s => s.branch === branch && s.division === division
        );

        if (currentYear !== 'all') {
            branchStudents = branchStudents.filter(student => student.year === currentYear);
        }

        branchStudents.sort((a, b) => {
            const rollA = parseInt(a.rollNo) || a.rollNo;
            const rollB = parseInt(b.rollNo) || b.rollNo;
            if (rollA < rollB) return -1;
            if (rollA > rollB) return 1;
            return 0;
        });

        const studentsWithAbsent = fillAbsentRollNumbers(branchStudents);

        const exportData = studentsWithAbsent.map(student => ({
            'Roll No': student.rollNo,
            'Name': student.name,
            'Branch': student.branch,
            'Division': student.division,
            'Year': student.year,
            'Score': student.isAbsent ? 'Absent' : student.score,
            'PRN': student.prn,
            'Email': student.email,
            'Timestamp': student.timestamp,
            'Status': student.isAbsent ? 'ABSENT' : 'Present'
        }));

        const ws = XLSX.utils.json_to_sheet(exportData);
        let sheetName = `${branch}-${division}`.substring(0, 31);
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
    });

    createSummarySheet(wb, Array.from(branches).sort());

    let fileName = 'student_data_branchwise';
    if (currentYear !== 'all') fileName += `_${currentYear}`;
    fileName += `_${getCurrentTimestamp()}.xlsx`;

    XLSX.writeFile(wb, fileName);
}

function createSummarySheet(wb, branchesList) {
    const summaryData = [];

    branchesList.forEach(branch => {
        let branchStudents = processedData.filter(student => student.branch === branch);

        if (currentYear !== 'all') {
            branchStudents = branchStudents.filter(student => student.year === currentYear);
        }

        if (branchStudents.length > 0) {
            const studentsWithAbsent = fillAbsentRollNumbers(branchStudents);
            const presentStudents = studentsWithAbsent.filter(s => !s.isAbsent);
            const absentStudents = studentsWithAbsent.filter(s => s.isAbsent);

            const totalScore = presentStudents.reduce((sum, student) => sum + student.score, 0);
            const avgScore = presentStudents.length > 0 ? totalScore / presentStudents.length : 0;
            const maxScore = presentStudents.length > 0 ? Math.max(...presentStudents.map(s => s.score)) : 0;
            const minScore = presentStudents.length > 0 ? Math.min(...presentStudents.map(s => s.score)) : 0;

            const highScoreCount = presentStudents.filter(s => s.score >= 25).length;
            const mediumScoreCount = presentStudents.filter(s => s.score >= 15 && s.score < 25).length;
            const lowScoreCount = presentStudents.filter(s => s.score < 15).length;

            summaryData.push({
                'Branch': branch,
                'Total Students': studentsWithAbsent.length,
                'Present': presentStudents.length,
                'Absent': absentStudents.length,
                'Average Score': avgScore.toFixed(2),
                'Highest Score': maxScore,
                'Lowest Score': minScore,
                'High (≥25)': highScoreCount,
                'Medium (15-24)': mediumScoreCount,
                'Low (<15)': lowScoreCount
            });
        }
    });

    const ws = XLSX.utils.json_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(wb, ws, 'Summary');
}

function getCurrentTimestamp() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hour = String(now.getHours()).padStart(2, '0');
    const minute = String(now.getMinutes()).padStart(2, '0');
    return `${year}${month}${day}_${hour}${minute}`;
}

function getCurrentFilteredData() {
    let filteredData = processedData.filter(student => {
        const branchMatch = currentBranch === 'all' || student.branch === currentBranch;
        const yearMatch = currentYear === 'all' || student.year === currentYear;
        const divisionMatch = currentDivision === 'all' || student.division === currentDivision;
        return branchMatch && yearMatch && divisionMatch;
    });

    filteredData = sortData(filteredData, currentSort);

    const grouped = {};
    filteredData.forEach(student => {
        const key = `${student.branch}-${student.division}|${student.year}`;
        if (!grouped[key]) {
            grouped[key] = [];
        }
        grouped[key].push(student);
    });

    let dataWithAbsent = [];
    Object.values(grouped).forEach(group => {
        const groupWithAbsent = fillAbsentRollNumbers(group);
        dataWithAbsent = dataWithAbsent.concat(groupWithAbsent);
    });

    return sortData(dataWithAbsent, currentSort);
}

function saveFilteredDataToDashboard() {
    if (!processedData || processedData.length === 0) {
        alert('⚠️ No data available to save!');
        return;
    }

    try {

        const dataToSave = getCurrentFilteredData();

        if (dataToSave.length === 0) {
            alert('⚠️ No data matches current filters!\n\nPlease adjust your filters and try again.');
            return;
        }

        const originalFileName = excelFileInput.files[0]?.name || 'Student_Data';
        
        let filterDesc = [];
        if (currentBranch !== 'all') filterDesc.push(currentBranch);
        if (currentDivision !== 'all') filterDesc.push(`Div-${currentDivision}`);
        if (currentYear !== 'all') filterDesc.push(currentYear.replace('Year ', 'Y'));
        
        const sortDesc = {
            'roll_asc': 'RollAsc',
            'roll_desc': 'RollDesc',
            'name_asc': 'NameAZ',
            'score_desc': 'ScoreHigh'
        };
        
        let fileName = originalFileName.replace(/\.[^/.]+$/, ''); 
        if (filterDesc.length > 0) {
            fileName += `_${filterDesc.join('_')}`;
        }
        if (currentSort !== 'roll_asc') {
            fileName += `_${sortDesc[currentSort]}`;
        }
        fileName += '_Filtered.xlsx';

        let dashboardData = JSON.parse(localStorage.getItem('teacherDashboard')) || {
            files: [],
            stats: { totalFiles: 0, totalStudents: 0, avgScore: 0, lastProcessed: null }
        };

        const absentCount = dataToSave.filter(s => s.isAbsent).length;
        const presentStudents = dataToSave.filter(s => !s.isAbsent);
        const totalScore = presentStudents.reduce((sum, s) => sum + s.score, 0);
        const avgScore = presentStudents.length > 0 ? (totalScore / presentStudents.length).toFixed(1) : 0;

        const filteredBranches = new Set();
        const filteredDivisions = new Set();
        const filteredYears = new Set();
        dataToSave.forEach(student => {
            if (student.branch) filteredBranches.add(student.branch);
            if (student.division) filteredDivisions.add(student.division);
            if (student.year) filteredYears.add(student.year);
        });

        const fileObject = {
            id: 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            fileName: fileName,
            originalFileName: originalFileName,
            processedAt: new Date().toISOString(),
            data: dataToSave,
            isFiltered: true,
            appliedFilters: {
                branch: currentBranch,
                division: currentDivision,
                year: currentYear,
                sort: currentSort
            },
            stats: {
                totalStudents: dataToSave.length,
                presentStudents: presentStudents.length,
                absentCount: absentCount,
                branches: Array.from(filteredBranches).sort(),
                divisions: Array.from(filteredDivisions).sort(),
                years: Array.from(filteredYears).sort(),
                averageScore: avgScore,
                maxScore: presentStudents.length > 0 ? Math.max(...presentStudents.map(s => s.score)) : 0,
                minScore: presentStudents.length > 0 ? Math.min(...presentStudents.map(s => s.score)) : 0
            },
            filters: {
                currentBranch: 'all',
                currentDivision: 'all',
                currentYear: 'all',
                currentSort: 'roll_asc'
            }
        };

        dashboardData.files.unshift(fileObject);

        if (dashboardData.files.length > 50) {
            dashboardData.files = dashboardData.files.slice(0, 50);
        }

        dashboardData.stats = {
            totalFiles: dashboardData.files.length,
            totalStudents: dashboardData.files.reduce((sum, f) => sum + f.stats.totalStudents, 0),
            avgScore: avgScore,
            lastProcessed: fileObject.processedAt
        };

        localStorage.setItem('teacherDashboard', JSON.stringify(dashboardData));
        localStorage.setItem(`dashboard_file_${fileObject.id}`, JSON.stringify(fileObject));
        
        let fileIndex = JSON.parse(localStorage.getItem('dashboard_file_index')) || [];
        fileIndex.unshift({
            id: fileObject.id,
            fileName: fileObject.fileName,
            processedAt: fileObject.processedAt
        });
        if (fileIndex.length > 50) {
            fileIndex = fileIndex.slice(0, 50);
        }
        localStorage.setItem('dashboard_file_index', JSON.stringify(fileIndex));

        let activities = JSON.parse(localStorage.getItem('dashboard_activities')) || [];
        activities.unshift({
            timestamp: new Date().toISOString(),
            message: `Saved filtered data: ${fileName}`,
            type: 'file_processed'
        });
        if (activities.length > 100) {
            activities = activities.slice(0, 100);
        }
        localStorage.setItem('dashboard_activities', JSON.stringify(activities));

        console.log('✅ Filtered data saved to dashboard with ID:', fileObject.id);
        
        let filterSummary = [];
        if (currentBranch !== 'all') filterSummary.push(`Branch: ${currentBranch}`);
        if (currentDivision !== 'all') filterSummary.push(`Division: ${currentDivision}`);
        if (currentYear !== 'all') filterSummary.push(`Year: ${currentYear}`);
        if (currentSort !== 'roll_asc') filterSummary.push(`Sort: ${sortDesc[currentSort]}`);
        
        alert(`✅ Filtered Data Saved!\n\nFile: ${fileName}\n\nFilters Applied:\n${filterSummary.join('\n') || 'None (All Data)'}\n\nStudents: ${fileObject.stats.totalStudents}\nPresent: ${fileObject.stats.presentStudents}\nAbsent: ${fileObject.stats.absentCount}\n\nAverage Score: ${avgScore}\n\nYou can now view this filtered dataset in the dashboard!`);

    } catch (error) {
        console.error('❌ Error saving filtered data:', error);
        alert('Error saving filtered data: ' + error.message);
    }
}

function saveToTeacherDashboard() {
    if (!processedData || processedData.length === 0) {
        console.log('⚠️ No data to save - skipping dashboard save');
        return;
    }

    if (!excelFileInput || !excelFileInput.files || excelFileInput.files.length === 0) {
        console.log('⚠️ No file selected - skipping dashboard save');
        return;
    }

    try {
        const fileName = excelFileInput.files[0].name;

        let dashboardData = JSON.parse(localStorage.getItem('teacherDashboard')) || {
            files: [],
            stats: { totalFiles: 0, totalStudents: 0, avgScore: 0, lastProcessed: null }
        };

        const absentCount = processedData.filter(s => s.isAbsent).length;
        const presentStudents = processedData.filter(s => !s.isAbsent);
        const totalScore = presentStudents.reduce((sum, s) => sum + s.score, 0);
        const avgScore = presentStudents.length > 0 ? (totalScore / presentStudents.length).toFixed(1) : 0;

        const fileObject = {
            id: 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            fileName: fileName,
            processedAt: new Date().toISOString(),
            data: processedData,
            stats: {
                totalStudents: processedData.length,
                presentStudents: presentStudents.length,
                absentCount: absentCount,
                branches: Array.from(branches).sort(),
                divisions: Array.from(divisions).sort(),
                years: Array.from(years).sort(),
                averageScore: avgScore,
                maxScore: presentStudents.length > 0 ? Math.max(...presentStudents.map(s => s.score)) : 0,
                minScore: presentStudents.length > 0 ? Math.min(...presentStudents.map(s => s.score)) : 0
            },
            filters: {
                currentBranch: currentBranch,
                currentDivision: currentDivision,
                currentYear: currentYear,
                currentSort: currentSort
            }
        };

        dashboardData.files.unshift(fileObject);

        if (dashboardData.files.length > 50) {
            dashboardData.files = dashboardData.files.slice(0, 50);
        }

        dashboardData.stats = {
            totalFiles: dashboardData.files.length,
            totalStudents: dashboardData.files.reduce((sum, f) => sum + f.stats.totalStudents, 0),
            avgScore: avgScore,
            lastProcessed: fileObject.processedAt
        };

        localStorage.setItem('teacherDashboard', JSON.stringify(dashboardData));
        localStorage.setItem(`dashboard_file_${fileObject.id}`, JSON.stringify(fileObject));
        
        let fileIndex = JSON.parse(localStorage.getItem('dashboard_file_index')) || [];
        fileIndex.unshift({
            id: fileObject.id,
            fileName: fileObject.fileName,
            processedAt: fileObject.processedAt
        });
        if (fileIndex.length > 50) {
            fileIndex = fileIndex.slice(0, 50);
        }
        localStorage.setItem('dashboard_file_index', JSON.stringify(fileIndex));

        let activities = JSON.parse(localStorage.getItem('dashboard_activities')) || [];
        activities.unshift({
            timestamp: new Date().toISOString(),
            message: `Processed file: ${fileName}`,
            type: 'file_processed'
        });
        if (activities.length > 100) {
            activities = activities.slice(0, 100);
        }
        localStorage.setItem('dashboard_activities', JSON.stringify(activities));

        console.log('✅ File saved to dashboard with ID:', fileObject.id);
        console.log('✅ Saved to key:', `dashboard_file_${fileObject.id}`);
        alert(`✅ Success!\n\nFile "${fileName}" saved to dashboard!\n\nFile ID: ${fileObject.id}\nStudents: ${fileObject.stats.totalStudents}\nPresent: ${fileObject.stats.presentStudents}\nAbsent: ${fileObject.stats.absentCount}\n\nAverage Score: ${avgScore}`);

    } catch (error) {
        console.error('❌ Error saving to dashboard:', error);
        alert('Error saving to dashboard: ' + error.message);
    }
}
function loadFileFromDashboard() {
    const urlParams = new URLSearchParams(window.location.search);
    const loadFileId = urlParams.get('load');
    
    if (!loadFileId) {
        console.log('No file ID in URL');
        return;
    }
    
    console.log('🔍 Attempting to load file ID:', loadFileId);
    console.log('🔍 Looking for key:', `dashboard_file_${loadFileId}`);
    
    try {
        const fileDataStr = localStorage.getItem(`dashboard_file_${loadFileId}`);
        
        if (!fileDataStr) {
            console.error('❌ File not found in localStorage with key:', `dashboard_file_${loadFileId}`);
            
            const dashboardData = JSON.parse(localStorage.getItem('teacherDashboard'));
            if (dashboardData && dashboardData.files) {
                const file = dashboardData.files.find(f => f.id === loadFileId);
                if (file) {
                    console.log('✅ Found file in dashboard files array');
                    loadFileData(file);
                    return;
                }
            }
            
            console.log('📋 Available dashboard files:');
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('dashboard_file_')) {
                    console.log('  -', key);
                }
            });
            
            alert('❌ File not found!\n\nThe file may have been deleted or the link is invalid.\n\nPlease go back to the dashboard and try again.');
            return;
        }
        
        const fileData = JSON.parse(fileDataStr);
        
        if (!fileData || !fileData.data) {
            console.error('❌ File data is corrupted');
            alert('❌ File data is corrupted!\n\nPlease try processing the file again.');
            return;
        }
        
        console.log('✅ File found:', fileData.fileName);
        loadFileData(fileData);
        
    } catch (error) {
        console.error('❌ Error loading file:', error);
        alert('❌ Error loading file from dashboard:\n\n' + error.message);
    }
}

function loadFileData(fileData) {
    console.log('📂 Loading file data:', fileData.fileName);
    
    rawData = fileData.data || [];
    processedData = [...rawData];
    
    branches.clear();
    divisions.clear();
    years.clear();
    
    rawData.forEach(student => {
        if (student.branch) branches.add(student.branch);
        if (student.division) divisions.add(student.division);
        if (student.year) years.add(student.year);
    });
    
    if (fileData.filters) {
        currentBranch = fileData.filters.currentBranch || 'all';
        currentDivision = fileData.filters.currentDivision || 'all';
        currentYear = fileData.filters.currentYear || 'all';
        currentSort = fileData.filters.currentSort || 'roll_asc';
    }
    
    fileNameDisplay.textContent = `📂 Loaded: ${fileData.fileName}`;
    fileNameDisplay.style.color = '#1a237e';
    fileNameDisplay.style.fontWeight = '600';
    
    controlsSection.style.display = 'block';
    dataSection.style.display = 'block';
    emptyState.style.display = 'none';
    
    exportSingleBtn.disabled = false;
    exportMultiBtn.disabled = false;
    saveFilteredBtn.disabled = false;
    
    updateFilters();
    filterAndDisplayData();
    updateStatistics();
    
    setTimeout(() => {
        alert(`✅ File Loaded Successfully!\n\nFile: ${fileData.fileName}\nStudents: ${fileData.stats.totalStudents}\nBranches: ${fileData.stats.branches.join(', ')}\n\nProcessed: ${new Date(fileData.processedAt).toLocaleString()}`);
    }, 500);
    
    window.history.replaceState({}, document.title, window.location.pathname);
}

document.addEventListener('DOMContentLoaded', function() {
    initTheme();
    setTimeout(loadFileFromDashboard, 100);
});
    </script>
    
</body>
</html>